# Phase 1: ObjectFactory Extensions

## Overview
Extend ObjectFactory with object registry capabilities to track objects by string IDs. This provides the foundation for the entire object ID tracking system.

## Current State Analysis
- `ObjectFactory` tracks objects by `Type` in `_queuedObjects` and `_alwaysObjects`
- `SetOne<T>()` and `SetAlways<T>()` methods exist for test object injection
- No object identification system exists

## Goals
1. Add bidirectional object registry (ID â†” object mapping)
2. Extend existing methods with optional ID parameters
3. Add new explicit registration methods
4. Provide lookup capabilities
5. Auto-generate IDs when not provided

---

## Tests to Implement First (TDD)

### Test File: `ObjectFactoryIdTests.cs`

#### 1. Basic Registration Tests
```csharp
[Fact]
public void Register_WithValidIdAndObject_ShouldStoreMapping()
[Fact] 
public void Register_WithDuplicateId_ShouldThrowException()
[Fact]
public void Register_WithNullId_ShouldThrowException()
[Fact]
public void Register_WithNullObject_ShouldThrowException()
```

#### 2. Auto-ID Generation Tests
```csharp
[Fact]
public void SetOne_WithoutId_ShouldGenerateAutoId()
[Fact]
public void SetAlways_WithoutId_ShouldGenerateAutoId()
[Fact]
public void AutoGeneratedIds_ShouldBeUnique()
[Fact]
public void AutoGeneratedIds_ShouldFollowPattern() // "obj_1", "obj_2", etc.
```

#### 3. Lookup Tests
```csharp
[Fact]
public void GetRegisteredId_WithRegisteredObject_ShouldReturnId()
[Fact]
public void GetRegisteredId_WithUnregisteredObject_ShouldReturnNull()
[Fact]
public void GetRegisteredObject_WithValidId_ShouldReturnObject()
[Fact]
public void GetRegisteredObject_WithInvalidId_ShouldReturnNull()
[Fact]
public void IsRegistered_WithRegisteredObject_ShouldReturnTrue()
[Fact]
public void IsRegistered_WithUnregisteredObject_ShouldReturnFalse()
```

#### 4. Extended SetOne/SetAlways Tests
```csharp
[Fact]
public void SetOne_WithId_ShouldRegisterObjectWithId()
[Fact]
public void SetAlways_WithId_ShouldRegisterObjectWithId()
[Fact]
public void SetOne_WithId_ShouldStillWorkForDependencyInjection()
[Fact]
public void SetAlways_WithId_ShouldStillWorkForDependencyInjection()
```

#### 5. Threading and Cleanup Tests
```csharp
[Fact]
public void Registry_ShouldBeThreadSafe()
[Fact]
public void Clear_ShouldRemoveFromRegistry()
[Fact]
public void ClearAll_ShouldClearRegistry()
[Fact]
public void Clear_SpecificType_ShouldOnlyRemoveRegisteredObjectsOfThatType()
```

---

## Implementation Plan

### Step 1: Add Registry Data Structures
```csharp
private readonly Dictionary<string, object> _registeredObjectsById = new();
private readonly Dictionary<object, string> _registeredIdsByObject = new();
private int _autoIdCounter = 1;
private readonly object _registryLock = new object();
```

### Step 2: Add Core Registry Methods
```csharp
public void Register<T>(T obj, string id)
public string? GetRegisteredId(object obj)
public T? GetRegisteredObject<T>(string id) where T : class
public bool IsRegistered(object obj)
private string GenerateAutoId()
```

### Step 3: Extend Existing Methods
```csharp
public void SetOne<T>(T obj, string? id = null)
public void SetAlways<T>(T obj, string? id = null)
```

### Step 4: Update Clear Methods
```csharp
// Modify existing Clear<T>() and ClearAll() to handle registry cleanup
```

### Step 5: Thread Safety
- All registry operations must be thread-safe
- Use `_registryLock` for synchronization
- Ensure consistency between the two dictionaries

---

## API Design

### New Public Methods
```csharp
// Explicit registration
void Register<T>(T obj, string id) where T : class

// Lookup methods  
string? GetRegisteredId(object obj)
T? GetRegisteredObject<T>(string id) where T : class
bool IsRegistered(object obj)

// Extended existing methods
void SetOne<T>(T obj, string? id = null)
void SetAlways<T>(T obj, string? id = null)
```

### Auto-ID Format
- Pattern: `"obj_{counter}"` (e.g., "obj_1", "obj_2", "obj_3")
- Thread-safe counter increment
- Unique across factory lifetime

### Error Handling
- `Register()` throws `ArgumentException` for duplicate IDs
- `Register()` throws `ArgumentNullException` for null parameters
- Lookup methods return `null` for not found (no exceptions)

---

## Test Verification Strategy

1. **Write all tests first** - ensure they fail appropriately
2. **Implement incrementally** - one method at a time
3. **Verify each test passes** after implementation
4. **Run full test suite** to ensure no regressions
5. **Test thread safety** with concurrent operations

## Expected Test Failures
Before implementation, all tests should fail with:
- `MissingMethodException` for new methods
- Compilation errors for new overloads
- Logic errors for registry functionality

## Success Criteria
- All Phase 1 tests pass
- Existing ObjectFactory tests still pass
- Thread safety verified
- Clean API design
- Auto-ID generation works reliably